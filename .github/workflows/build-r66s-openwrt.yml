# å·¥ä½œæµåç§°ï¼šæ„å»º R66S OpenWrt å›ºä»¶
name: build r66s openwrt

# è§¦å‘æ¡ä»¶
on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© 14:00 UTC æ‰§è¡Œ
  schedule:
    - cron: 0 14 * * *
  # å½“æœ‰äºº star ä»“åº“æ—¶è§¦å‘
  watch:
    types: started

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  # Clash å†…æ ¸æ¶æ„
  CLASH_KERNEL: arm64
  # æ˜¯å¦ç¼“å­˜ç¼–è¯‘å·¥å…·é“¾
  CACHE_TOOLCHAIN: true
  # æ˜¯å¦ä¸Šä¼  bin ç›®å½•
  UPLOAD_BIN_DIR: false
  # æ˜¯å¦ä¸Šä¼ æ„å»ºäº§ç‰©
  UPLOAD_ARTIFACT: false
  # æ˜¯å¦å‘å¸ƒ Release
  UPLOAD_RELEASE: true
  # æ—¶åŒºè®¾ç½®
  TZ: Asia/Shanghai

# å·¥ä½œæµä»»åŠ¡
jobs:
  # æ„å»ºä»»åŠ¡
  build:
    # è¿è¡Œç¯å¢ƒï¼šUbuntu 22.04
    runs-on: ubuntu-22.04
    # ä»…å…è®¸ä»“åº“æ‰€æœ‰è€…è§¦å‘ï¼Œæˆ–è€…æ˜¯é¦–æ¬¡è§¦å‘
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id
    # æ„å»ºä»»åŠ¡åç§°ï¼Œæ˜¾ç¤ºç›®æ ‡æ¶æ„å’Œ OpenWrt ç‰ˆæœ¬
    name: build ${{ matrix.target }} ${{ matrix.openwrt }}
    # æ„å»ºç­–ç•¥
    strategy:
      # å…è®¸éƒ¨åˆ†ä»»åŠ¡å¤±è´¥
      fail-fast: false
      # æ„å»ºçŸ©é˜µï¼šä¸åŒç›®æ ‡å’Œ OpenWrt ç‰ˆæœ¬ç»„åˆ
      matrix:
        target: [armv8]
        openwrt: [lede, immortalwrt]

    # ä»»åŠ¡çº§ç¯å¢ƒå˜é‡
    env:
      # é…ç½®æ–‡ä»¶è·¯å¾„
      CONFIG_FILE: configs/${{ matrix.target }}.config
      # è‡ªå®šä¹‰è„šæœ¬è·¯å¾„
      DIY_SCRIPT: diy-${{ matrix.openwrt }}.sh
      # Release æ ‡ç­¾
      RELEASE_TAG: ${{ matrix.target }}-${{ matrix.openwrt }}

    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@main

    # è®¾ç½®ç¼–è¯‘æºç ç›¸å…³å˜é‡
    - name: Set Compile Source Code
      run: |
        # æ ¹æ®ä¸åŒçš„ OpenWrt ç‰ˆæœ¬è®¾ç½®å¯¹åº”çš„ä»“åº“ä¿¡æ¯
        if [ ${{ matrix.openwrt }} == 'lede' ]; then
          # Lean çš„ OpenWrt æºç 
          echo "REPO_URL=https://github.com/coolsnowwolf/lede" >> $GITHUB_ENV
          echo "REPO_BRANCH=master" >> $GITHUB_ENV
          # è®¾ç½®ç›®æ ‡æ¶æ„ä¸º arm64 è™šæ‹Ÿæœº
          echo -e "CONFIG_TARGET_armvirt=y\nCONFIG_TARGET_armvirt_64=y" >> $CONFIG_FILE
        elif [ ${{ matrix.openwrt }} == 'immortalwrt' ]; then
          # ImmortalWrt æºç 
          echo "REPO_URL=https://github.com/immortalwrt/immortalwrt" >> $GITHUB_ENV
          echo "REPO_BRANCH=openwrt-24.10" >> $GITHUB_ENV
          # è®¾ç½®ç›®æ ‡æ¶æ„ä¸º armsr
          echo -e "CONFIG_TARGET_armsr=y\nCONFIG_TARGET_armsr_armv8=y" >> $CONFIG_FILE
        fi

    # æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½
    - name: Check Server Performance
      run: |
        # æ˜¾ç¤ºæ€§èƒ½è­¦å‘Šä¿¡æ¯
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
        # æ˜¾ç¤º CPU ä¿¡æ¯
        echo "==========================CPUä¿¡æ¯=========================="
        echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPUçº¿ç¨‹æ•°é‡: $(nproc)"
        echo -e "CPUå‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
        # æ˜¾ç¤ºå†…å­˜ä¿¡æ¯
        echo "==========================å†…å­˜ä¿¡æ¯=========================="
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
        # æ˜¾ç¤ºç¡¬ç›˜ä¿¡æ¯
        echo "==========================ç¡¬ç›˜ä¿¡æ¯=========================="
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    # åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
    - name: Initialization Environment
      env:
        # è®¾ç½®æ— äº¤äº’æ¨¡å¼
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ¸…ç† Docker é•œåƒ
        docker rmi $(docker images -q)
        # åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶å’Œç›®å½•
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android $AGENT_TOOLSDIRECTORY
        # å…³é—­å¹¶åˆ é™¤äº¤æ¢æ–‡ä»¶
        sudo swapoff -a && sudo rm -f /swapfile /mnt/swapfile
        # å¸è½½ä¸éœ€è¦çš„è½¯ä»¶åŒ…
        sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
        # æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…
        sudo -E apt-get -y update
        sudo -E apt-get -y install clang rename $(curl -fsSL is.gd/depends_ubuntu_2204)
        sudo -E systemctl daemon-reload
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get -y clean
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$TZ"

    # åˆå¹¶ç£ç›˜ç©ºé—´
    - name: Combine Disks
      run: |
        # è®¡ç®— /mnt åˆ†åŒºå¯ç”¨ç©ºé—´å¹¶åˆ›å»ºé•œåƒæ–‡ä»¶
        MNT_SIZE=$((($(df --block-size=1024 --output=avail /mnt | tail -1) - 1024*1024*1) * 1024))
        sudo fallocate -l $MNT_SIZE /mnt/mnt.img
        MNT_NAME=$(sudo losetup -Pf --show /mnt/mnt.img)
        sudo pvcreate -f $MNT_NAME
        # è®¡ç®—æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´å¹¶åˆ›å»ºé•œåƒæ–‡ä»¶
        ROOT_SIZE=$((($(df --block-size=1024 --output=avail / | tail -1) - 1024*1024*4) * 1024))
        sudo fallocate -l $ROOT_SIZE /root.img
        ROOT_NAME=$(sudo losetup -Pf --show /root.img)
        sudo pvcreate -f $ROOT_NAME
        # åˆ›å»ºå·ç»„å’Œé€»è¾‘å·
        sudo vgcreate actions $MNT_NAME $ROOT_NAME
        sudo lvcreate -n disk -l 100%FREE actions
        LV_NAME=$(sudo lvscan | awk -F "'" '{print $2}')
        # æ ¼å¼åŒ–ä¸º btrfs æ–‡ä»¶ç³»ç»Ÿå¹¶æŒ‚è½½
        sudo mkfs.btrfs -L combinedisk $LV_NAME
        sudo mkdir -p /workdir
        sudo mount -o compress=zstd $LV_NAME /workdir
        sudo chown -R runner:runner /workdir && df -hT

    - name: Clone Source Code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        # è·å–æœ€åä¸€æ¬¡æäº¤çš„ä½œè€…ä¿¡æ¯
        COMMIT_AUTHOR=$(git show -s --date=short --format="ä½œè€…: %an")
        echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV
        # è·å–æœ€åä¸€æ¬¡æäº¤çš„æ—¶é—´
        COMMIT_DATE=$(git show -s --date=short --format="æ—¶é—´: %ci")
        echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
        # è·å–æœ€åä¸€æ¬¡æäº¤çš„æè¿°
        COMMIT_MESSAGE=$(git show -s --date=short --format="å†…å®¹: %s")
        echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
        # è·å–æœ€åä¸€æ¬¡æäº¤çš„å“ˆå¸Œå€¼
        COMMIT_HASH=$(git show -s --date=short --format="hash: %H")
        echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV

    # ç”Ÿæˆç¼–è¯‘ç›¸å…³å˜é‡
    - name: Generate Variables
      run: |
        # å¤åˆ¶é…ç½®æ–‡ä»¶å¹¶ç”Ÿæˆé»˜è®¤é…ç½®
        cp $CONFIG_FILE $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        make defconfig > /dev/null 2>&1
        # è·å–æºç ä»“åº“åç§°
        SOURCE_REPO=$(echo $REPO_URL | awk -F '/' '{print $(NF)}')
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        # è·å–ç›®æ ‡è®¾å¤‡å¹³å°
        DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        # è·å–ç›®æ ‡è®¾å¤‡å­å¹³å°
        DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        # è·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
        KERNEL=$(grep -oP 'KERNEL_PATCHVER:=\K[^ ]+' target/linux/$DEVICE_TARGET/Makefile)
        KERNEL_VERSION=$(sed -n 2p include/kernel-$KERNEL | awk -F '-' '{print $2}' | awk -F ' ' '{print $1}')
        echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV

    # ç¼“å­˜ç¼–è¯‘å·¥å…·é“¾
    - name: Cache Toolchain
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false
        mixkey: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
        prefix: ${{ env.OPENWRT_PATH }}

    - name: Install Feeds
      run: |
        cd $OPENWRT_PATH
        # å¦‚æœæ˜¯ LEDE æºç ï¼Œè°ƒæ•´ feeds.conf.default é…ç½®
        if [ $SOURCE_REPO == 'lede' ]; then
          sed -i '/luci/s/^#//; /openwrt-23.05/s/^/#/' feeds.conf.default
        fi
        # æ›´æ–°å¹¶å®‰è£…æ‰€æœ‰è½¯ä»¶æº
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # åŠ è½½è‡ªå®šä¹‰é…ç½®
    - name: Load Custom Configuration
      run: |
        # ç§»åŠ¨æ–‡ä»¶åˆ° OpenWrt ç›®å½•
        [ -e files ] && mv files $OPENWRT_PATH/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE $OPENWRT_PATH/.config
        # æ·»åŠ è„šæœ¬æ‰§è¡Œæƒé™
        chmod +x $GITHUB_WORKSPACE/scripts/*.sh
        chmod +x $DIY_SCRIPT
        cd $OPENWRT_PATH
        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        $GITHUB_WORKSPACE/$DIY_SCRIPT
        $GITHUB_WORKSPACE/scripts/preset-clash-core.sh $CLASH_KERNEL

    # ä¸‹è½½ä¾èµ–åŒ…
    - name: Download DL Package
      run: |
        cd $OPENWRT_PATH
        make defconfig
        # å¹¶è¡Œä¸‹è½½ä¾èµ–åŒ…
        make download -j$(nproc)
        # æ£€æŸ¥å¹¶åˆ é™¤å°äº 1KB çš„æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ä¸‹è½½å¤±è´¥çš„æ–‡ä»¶ï¼‰
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    # ç¼–è¯‘å›ºä»¶
    - name: Compile Firmware
      id: compile
      run: |
        cd $OPENWRT_PATH
        # åˆ›å»ºåˆå§‹åŒ–è®¾ç½®ç›®å½•
        mkdir -p files/etc/uci-defaults
        cp $GITHUB_WORKSPACE/scripts/init-settings.sh files/etc/uci-defaults/99-init-settings
        # æ˜¾ç¤ºç¼–è¯‘çº¿ç¨‹æ•°
        echo -e "$(nproc) thread compile"
        # å°è¯•å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¦‚æœå¤±è´¥åˆ™é™çº§åˆ°å•çº¿ç¨‹
        make -j$(nproc) || make -j1 || make -j1 V=s
        # è·å–é»˜è®¤ IP åœ°å€
        DEFAULT_IP=$(grep 'n) ipad' package/base-files/files/bin/config_generate | cut -d '"' -f2)
        echo "DEFAULT_IP=$DEFAULT_IP" >> $GITHUB_ENV
        # è®¾ç½®æ—¥æœŸå˜é‡
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: Check Space Usage
      if: (!cancelled())
      run: df -hT

    - name: Upload Bin Directory
      if: steps.compile.conclusion == 'success' && env.UPLOAD_BIN_DIR == 'true'
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: Packaging OpenWrt
      if: steps.compile.conclusion == 'success'
      uses: haiibo/flippy-openwrt-actions@main
      env:
        OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/*rootfs.tar.gz
        KERNEL_REPO_URL: ophub/kernel
        KERNEL_USAGE: flippy
        PACKAGE_SOC: r66s_s905d
        KERNEL_VERSION_NAME: 6.1.y_6.6.y
        KERNEL_AUTO_LATEST: true

    # æ•´ç†æ–‡ä»¶æ­¥éª¤
    - name: Organize Files
      # ä»…åœ¨æ‰“åŒ…æˆåŠŸæ—¶æ‰§è¡Œ
      if: env.PACKAGED_STATUS == 'success'
      run: |
        # è¿›å…¥ç›®æ ‡æ–‡ä»¶å¤¹
        cd $OPENWRT_PATH/bin/targets/*/*
        # æ˜¾ç¤ºæ„å»ºé…ç½®ä¿¡æ¯
        cat config.buildinfo
        # å¤åˆ¶ OpenWrt é…ç½®æ–‡ä»¶
        cp $OPENWRT_PATH/.config build.config
        # ç§»åŠ¨æ‰€æœ‰ ipk åŒ…åˆ° packages ç›®å½•
        mv -f $OPENWRT_PATH/bin/packages/*/*/*.ipk packages
        # å°† packages ç›®å½•æ‰“åŒ…æˆ tar.gz
        tar -zcf packages.tar.gz packages
        # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        rm -rf packages u-boot-qemu* feeds.buildinfo version.buildinfo sha256sums *.manifest *.bin
        # è®¾ç½®å›ºä»¶è·¯å¾„ç¯å¢ƒå˜é‡
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        # è¿›å…¥æ‰“åŒ…è¾“å‡ºç›®å½•å¹¶æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
        cd $PACKAGED_OUTPUTPATH && rm -f *rootfs.tar.gz *.sha
        # å¦‚æœæ˜¯ immortalwrt æºç ï¼Œé‡å‘½åæ–‡ä»¶
        if [ $SOURCE_REPO == 'immortalwrt' ]; then
          rename 's/openwrt/${{ env.SOURCE_REPO }}/' *
        fi

    # å°† OpenWrt å›ºä»¶ä¸Šä¼ åˆ° Artifacts
    - name: Upload OpenWrt To Artifact
      if: env.PACKAGED_STATUS == 'success' && env.UPLOAD_ARTIFACT == 'true'
      uses: haiibo/upload-artifact-as-is@master
      with:
        path: ${{ env.PACKAGED_OUTPUTPATH }}

    # å°† OpenWrt å›ºä»¶å‘å¸ƒåˆ° Release
    - name: Upload OpenWrt To Release
      if: env.PACKAGED_STATUS == 'success' && env.UPLOAD_RELEASE == 'true'
      uses: ncipollo/release-action@main
      with:
        # Release åç§°ï¼šæ—¥æœŸ + ç›®æ ‡è®¾å¤‡ä¿¡æ¯
        name: ${{ env.DATE }} for ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
        # å…è®¸æ›´æ–°å·²å­˜åœ¨çš„ Release
        allowUpdates: true
        # ç§»é™¤æ—§çš„ Artifacts
        removeArtifacts: true
        # Release æ ‡ç­¾
        tag: ${{ env.RELEASE_TAG }}
        # GitHub Token
        token: ${{ secrets.GITHUB_TOKEN }}
        # ä¸Šä¼ çš„æ–‡ä»¶
        artifacts: ${{ env.FIRMWARE_PATH }}/*,${{ env.PACKAGED_OUTPUTPATH }}/*
        # Release æè¿°ä¿¡æ¯
        body: |
          **This is OpenWrt Firmware for ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}**
          ### ğŸ“’ å›ºä»¶ä¿¡æ¯
          - ğŸ’» å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
          - ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          - ğŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
          - ğŸŒ é»˜è®¤åœ°å€: ${{ env.DEFAULT_IP }}
          - ğŸ”‘ é»˜è®¤å¯†ç : password
          ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
          - ${{ env.COMMIT_AUTHOR }}
          - ${{ env.COMMIT_DATE }}
          - ${{ env.COMMIT_MESSAGE }}
          - ${{ env.COMMIT_HASH }}
